<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOL Slot Machine with Real Wallet Payment</title>
  <style>
    /* Same styling as before, omitted for brevity */
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0b0c10;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    h1 {
      color: #00ffa3;
      margin-bottom: 30px;
    }
    .slot-machine {
      margin: 20px auto;
      width: 300px;
      border: 3px solid #00ffa3;
      border-radius: 10px;
      padding: 20px;
      background: #1f2833;
      box-shadow: 0 0 20px rgba(0, 255, 163, 0.3);
    }
    .slots {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .slot {
      width: 80px;
      height: 80px;
      border: 2px solid #45a29e;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #0b0c10;
      font-size: 40px;
      transition: transform 0.3s;
    }
    .slot.spinning {
      animation: slot-spin 0.1s infinite;
    }
    button {
      background: #00ffa3;
      color: #0b0c10;
      border: none;
      padding: 12px 25px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      margin-top: 10px;
    }
    button:hover {
      background: #00cc88;
      transform: scale(1.05);
    }
    button:disabled {
      background: #45a29e;
      cursor: not-allowed;
      transform: none;
    }
    .result {
      margin-top: 20px;
      font-size: 18px;
      min-height: 50px;
    }
    .balance {
      margin-top: 15px;
      font-size: 16px;
      color: #66fcf1;
    }
    .wallet-section {
      margin-bottom: 15px;
    }
    @keyframes slot-spin {
      0% { transform: translateY(-10px); }
      50% { transform: translateY(10px); }
      100% { transform: translateY(-10px); }
    }
    @keyframes win-flash {
      0% { background: #1f2833; }
      50% { background: #00ffa3; }
      100% { background: #1f2833; }
    }
    .jackpot {
      animation: win-flash 0.5s 3;
    }
  </style>
</head>
<body>
  <h1>SOL Slot Machine ðŸŽ°</h1>

  <div class="wallet-section">
    <button id="connectWalletBtn">Connect Wallet</button>
    <div id="walletAddress" style="margin-top: 8px; font-size: 14px;"></div>
  </div>

  <div class="slot-machine" id="slot-machine">
    <div class="slots">
      <div class="slot" id="slot1">ðŸª™</div>
      <div class="slot" id="slot2">ðŸª™</div>
      <div class="slot" id="slot3">ðŸª™</div>
    </div>
    <button onclick="spin()" id="spinButton" disabled>Spin (1 SOL)</button>
    <div class="result" id="result"></div>
    <div class="balance" id="balance">Balance: --</div>
  </div>

  <script type="module">
    import {
      Connection,
      PublicKey,
      clusterApiUrl,
      SystemProgram,
      Transaction
    } from "https://cdn.skypack.dev/@solana/web3.js";

    const symbols = [
      { name: "Solana", emoji: "ðŸª™" },
      { name: "Rocket", emoji: "ðŸš€" },
      { name: "Diamond", emoji: "ðŸ’Ž" },
      { name: "Money", emoji: "ðŸ’°" },
      { name: "Fire", emoji: "ðŸ”¥" }
    ];

    const treasuryPublicKey = new PublicKey('YOUR_TREASURY_WALLET_ADDRESS_HERE'); 
    // <-- Replace with your treasury wallet public key

    let connection = new Connection(clusterApiUrl('devnet'), 'confirmed');
    let walletConnected = false;
    let walletPublicKey = null;
    let isSpinning = false;
    let balance = 0;

    const balanceDisplay = document.getElementById('balance');
    const spinButton = document.getElementById('spinButton');
    const resultDisplay = document.getElementById('result');
    const slotElements = [
      document.getElementById('slot1'),
      document.getElementById('slot2'),
      document.getElementById('slot3')
    ];
    const connectWalletBtn = document.getElementById('connectWalletBtn');
    const walletAddressDisplay = document.getElementById('walletAddress');

    async function connectWallet() {
      if (window.solana && window.solana.isPhantom) {
        try {
          const resp = await window.solana.connect();
          walletPublicKey = resp.publicKey;
          walletConnected = true;
          walletAddressDisplay.textContent = `Wallet: ${walletPublicKey.toString()}`;
          connectWalletBtn.textContent = "Disconnect Wallet";
          spinButton.disabled = false;

          await updateBalance();
        } catch (err) {
          console.error('Wallet connection failed', err);
          walletAddressDisplay.textContent = 'Wallet connection failed';
        }
      } else {
        alert('Phantom wallet not found. Please install it!');
      }
    }

    function disconnectWallet() {
      walletConnected = false;
      walletPublicKey = null;
      walletAddressDisplay.textContent = '';
      connectWalletBtn.textContent = "Connect Wallet";
      balanceDisplay.textContent = "Balance: --";
      spinButton.disabled = true;
      resetSlots();
      resultDisplay.textContent = '';
    }

    connectWalletBtn.onclick = () => {
      if (walletConnected) {
        disconnectWallet();
      } else {
        connectWallet();
      }
    };

    async function updateBalance() {
      if (!walletConnected) {
        balanceDisplay.textContent = "Balance: --";
        spinButton.disabled = true;
        return;
      }
      const lamports = await connection.getBalance(walletPublicKey);
      balance = lamports / 1e9; // convert lamports to SOL
      balanceDisplay.textContent = `Balance: ${balance.toFixed(3)} SOL`;
      spinButton.disabled = balance < 1 || isSpinning;
    }

    function resetSlots() {
      slotElements.forEach(slot => slot.textContent = 'ðŸª™');
    }

    async function spin() {
      if (!walletConnected) {
        alert("Please connect your wallet first.");
        return;
      }
      if (isSpinning) return;
      if (balance < 1) {
        alert("Insufficient balance to spin.");
        return;
      }

      isSpinning = true;
      spinButton.disabled = true;
      resultDisplay.textContent = "Waiting for payment approval...";

      try {
        // Create transaction to send 1 SOL to treasury as spin cost
        const transaction = new Transaction().add(
          SystemProgram.transfer({
            fromPubkey: walletPublicKey,
            toPubkey: treasuryPublicKey,
            lamports: 1e9 // 1 SOL in lamports
          })
        );

        transaction.feePayer = walletPublicKey;
        let { blockhash } = await connection.getRecentBlockhash();
        transaction.recentBlockhash = blockhash;

        // Request user signature and send transaction
        const signed = await window.solana.signTransaction(transaction);
        const signature = await connection.sendRawTransaction(signed.serialize());
        resultDisplay.textContent = "Transaction sent, awaiting confirmation...";
        await connection.confirmTransaction(signature);

        resultDisplay.textContent = "Payment confirmed! Spinning...";
        await updateBalance();

        // Spin animation & results
        slotElements.forEach(slot => slot.classList.add('spinning'));

        const results = [
          symbols[Math.floor(Math.random() * symbols.length)],
          symbols[Math.floor(Math.random() * symbols.length)],
          symbols[Math.floor(Math.random() * symbols.length)]
        ];

        setTimeout(() => {
          slotElements.forEach((slot, i) => {
            slot.classList.remove('spinning');
            slot.textContent = results[i].emoji;
          });

          let winAmount = 0;
          if (results[0].name === results[1].name && results[1].name === results[2].name) {
            winAmount = 50;
            resultDisplay.innerHTML = `ðŸŽ‰ <strong>JACKPOT!</strong> 3 ${results[0].name}s! +${winAmount} SOL`;
            document.getElementById("slot-machine").classList.add("jackpot");
            setTimeout(() => {
              document.getElementById("slot-machine").classList.remove("jackpot");
            }, 1500);
          } else if (
            results[0].name === results[1].name ||
            results[1].name === results[2].name ||
            results[0].name === results[2].name
          ) {
            winAmount = 5;
            resultDisplay.textContent = `ðŸ˜Ž Nice! 2 matching symbols! +${winAmount} SOL`;
          } else {
            resultDisplay.textContent = "ðŸ™ƒ Try again!";
          }

          // TODO: Send winnings back to user here (requires server or program)

          isSpinning = false;
          updateBalance();
          spinButton.disabled = balance < 1;
        }, 1500);

      } catch (error) {
        console.error('Transaction failed', error);
        resultDisplay.textContent = `Transaction failed: ${error.message}`;
        isSpinning = false;
        spinButton.disabled = balance < 1;
      }
    }
  </script>
</body>
</html>
